---
title: Configuration Guide
description: Complete guide to configuring Afilmory Builder for different storage backends and performance scenarios.
---

import { Callout } from 'fumadocs-ui/components/callout';

## Configuration File Structure

Builder uses `builder.config.ts` as the main configuration file:

```typescript
import type { BuilderConfig } from '@afilmory/builder';

export default {
  storage: {
    // Storage configuration
  },
  performance: {
    // Performance optimization settings
  },
  options: {
    // General builder options
  }
} satisfies BuilderConfig;
```

## Storage Configuration

### Amazon S3 Configuration

```typescript
export default {
  storage: {
    provider: 's3',
    bucket: 'your-photo-bucket',
    region: 'us-west-2',
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
    customDomain: 'https://cdn.example.com', // Optional CDN domain
    endpoint: 'https://s3.amazonaws.com', // Optional custom endpoint
    pathStyle: false, // Use path-style URLs
    uploadOptions: {
      acl: 'public-read',
      cacheControl: 'max-age=31536000', // 1 year cache
      contentType: 'image/jpeg'
    }
  }
}
```

<Callout type="info">
**S3-Compatible Storage**: Builder supports any S3-compatible storage service like MinIO, DigitalOcean Spaces, or Cloudflare R2. Just configure the appropriate `endpoint`.
</Callout>

### GitHub Storage Configuration

```typescript
export default {
  storage: {
    provider: 'github',
    owner: 'your-username',
    repo: 'photo-storage',
    branch: 'main', // Optional, defaults to 'main'
    token: process.env.GITHUB_TOKEN,
    baseUrl: 'https://raw.githubusercontent.com/your-username/photo-storage/main',
    uploadOptions: {
      message: 'Add new photos', // Commit message template
      committer: {
        name: 'Afilmory Builder',
        email: 'builder@afilmory.com'
      }
    }
  }
}
```

### Local Storage Configuration

```typescript
export default {
  storage: {
    provider: 'local',
    basePath: '/path/to/photo/directory',
    baseUrl: 'http://localhost:3000/photos', // Base URL for serving photos
    uploadOptions: {
      createDirectories: true, // Auto-create directory structure
      overwrite: false // Don't overwrite existing files
    }
  }
}
```

## Performance Configuration

### Worker Configuration

```typescript
export default {
  performance: {
    worker: {
      // Choose processing mode
      useClusterMode: true, // Use cluster mode for CPU-intensive tasks
      
      // Cluster mode settings
      workerCount: 8, // Number of worker processes (defaults to CPU cores)
      workerConcurrency: 2, // Concurrent tasks per worker
      
      // Thread pool settings (when useClusterMode is false)
      threadPoolSize: 4, // Number of worker threads
      maxQueueSize: 100, // Maximum queued tasks
      
      // Memory management
      memoryLimit: '4GB', // Memory limit per worker
      restartWorkerAfter: 1000 // Restart worker after N tasks
    },
    
    // Processing concurrency
    concurrency: {
      photoProcessing: 10, // Concurrent photo processing tasks
      thumbnailGeneration: 8, // Concurrent thumbnail generation
      uploadTasks: 5 // Concurrent upload operations
    },
    
    // Caching configuration
    cache: {
      enabled: true,
      directory: '.cache/builder', // Cache directory
      maxSize: '10GB', // Maximum cache size
      ttl: 7 * 24 * 60 * 60 * 1000 // Cache TTL in milliseconds (7 days)
    }
  }
}
```

### Optimization Settings

```typescript
export default {
  performance: {
    optimization: {
      // Image processing optimization
      imageOptimization: {
        quality: 85, // JPEG quality (1-100)
        progressive: true, // Progressive JPEG
        mozjpeg: true, // Use mozjpeg encoder
        webpQuality: 80, // WebP quality for thumbnails
      },
      
      // Thumbnail settings
      thumbnails: {
        sizes: [300, 600, 1200], // Thumbnail sizes
        format: 'webp', // Thumbnail format
        skipLargeImages: true, // Skip thumbnails for very large images
        maxDimension: 8000 // Maximum image dimension to process
      },
      
      // EXIF processing
      exif: {
        preserveOriginal: false, // Remove EXIF from processed images
        extractGPS: true, // Extract GPS coordinates
        extractCamera: true, // Extract camera information
        extractLens: true // Extract lens information
      }
    }
  }
}
```

## General Options

### Feature Toggles

```typescript
export default {
  options: {
    // Core features
    enableLivePhotoDetection: true, // Detect iPhone Live Photos
    enableHDRDetection: true, // Detect HDR images
    enableRAWProcessing: false, // Process RAW files (experimental)
    
    // Image analysis
    generateThumbHash: true, // Generate ThumbHash for each image
    analyzeTone: true, // Perform tone analysis
    generateHistogram: true, // Generate color histogram
    
    // Camera-specific features
    extractFujiRecipe: true, // Extract Fujifilm film simulation settings
    extractSonyRecipe: true, // Extract Sony picture profile settings
    
    // Processing behavior
    skipExistingFiles: true, // Skip already processed files
    validateImageIntegrity: true, // Validate image files
    generateChecksums: true, // Generate file checksums
    
    // Output options
    prettyPrintJson: false, // Pretty print manifest JSON
    includeDebugInfo: false // Include debug information in manifest
  }
}
```

### Path Configuration

```typescript
export default {
  options: {
    paths: {
      // Input paths
      photoDirectory: 'photos/', // Source photo directory
      excludePatterns: ['*.tmp', '.*', 'thumbnails/'], // Exclude patterns
      
      // Output paths
      manifestPath: 'photos-manifest.json', // Manifest output path
      thumbnailDirectory: 'thumbnails/', // Thumbnail output directory
      cacheDirectory: '.cache/', // Cache directory
      
      // Naming patterns
      thumbnailNaming: '{name}-{size}.{ext}', // Thumbnail naming pattern
      manifestBackupPath: 'manifest-backup-{timestamp}.json' // Backup naming
    }
  }
}
```

## Environment-Specific Configurations

### Development Configuration

```typescript
// builder.config.dev.ts
export default {
  storage: {
    provider: 'local',
    basePath: './dev-photos',
    baseUrl: 'http://localhost:3000/photos'
  },
  performance: {
    worker: {
      useClusterMode: false, // Simpler debugging in dev
      threadPoolSize: 2
    }
  },
  options: {
    includeDebugInfo: true,
    prettyPrintJson: true,
    validateImageIntegrity: false // Faster processing in dev
  }
}
```

### Production Configuration

```typescript
// builder.config.prod.ts
export default {
  storage: {
    provider: 's3',
    bucket: process.env.S3_BUCKET,
    region: process.env.AWS_REGION,
    customDomain: process.env.CDN_DOMAIN
  },
  performance: {
    worker: {
      useClusterMode: true,
      workerCount: 16, // High performance for production
      workerConcurrency: 4
    },
    optimization: {
      imageOptimization: {
        quality: 90, // Higher quality for production
        progressive: true
      }
    }
  },
  options: {
    includeDebugInfo: false,
    prettyPrintJson: false, // Smaller manifest size
    validateImageIntegrity: true
  }
}
```

## Configuration Validation

Builder automatically validates configuration at startup:

```typescript
import { validateConfig } from '@afilmory/builder';

const config = {
  // Your configuration
};

try {
  validateConfig(config);
  console.log('Configuration is valid');
} catch (error) {
  console.error('Configuration error:', error.message);
}
```

## Environment Variables

Builder supports environment variable substitution:

```bash
# .env file
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
S3_BUCKET=my-photo-bucket
CDN_DOMAIN=https://photos.example.com
GITHUB_TOKEN=ghp_xxxxxxxxxxxx
```

```typescript
// builder.config.ts
export default {
  storage: {
    provider: 's3',
    bucket: process.env.S3_BUCKET!,
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
    customDomain: process.env.CDN_DOMAIN
  }
}
```

<Callout type="warning">
**Security Note**: Never commit sensitive credentials to version control. Always use environment variables or secure secret management systems.
</Callout>

## Configuration Best Practices

1. **Use TypeScript**: Leverage TypeScript for configuration to catch errors early
2. **Environment-specific configs**: Maintain separate configurations for different environments
3. **Performance tuning**: Adjust worker and concurrency settings based on your hardware
4. **Security**: Use environment variables for sensitive data
5. **Monitoring**: Enable appropriate logging and debug options for troubleshooting

Next: [Command Line Usage](./cli-usage.mdx)
